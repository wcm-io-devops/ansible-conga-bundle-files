# set bundle name and path of the file generated by conga
- name: Set bundle facts.
  set_fact:
    _bundle: "{{ _bundle_file.bundleFileProperties.bundle }}"
    _path: "{{ _bundle_file.path }}"

# query the bundle API to retrieve the id
- name: "Query bundle api for:  {{ _bundle }}"
  uri:
    url: "{{ conga_bundle_files_aem_api_prefix }}{{ _bundle }}.json"
    force_basic_auth: yes
    user: "{{ conga_bundle_files_aem_user }}"
    password: "{{ conga_bundle_files_aem_password }}"
    timeout: "{{ conga_bundle_files_aem_api_timeout }}"
    return_content: yes
  register: bundle_json

# set the target path of the files
- name: "Set bundle path"
  set_fact:
    _bundle_data_target_path: "{{ conga_bundle_files_target_dir_prefix }}{{ bundle_json.json.data[0].id }}\
                              /{{ conga_bundle_files_target_data_dir }}"

# copy the bundle file to the target system
- name: Copy CONGA bundle file to the target system.
  copy:
    src: "{{ conga_config_path }}/{{ _path }}"
    dest: "{{ conga_bundle_files_base_path }}/{{ _bundle_data_target_path }}/{{ _path | basename }}"
    owner: "{{ conga_bundle_files_owner | default(omit) }}"
    group: "{{ conga_bundle_files_group | default(omit) }}"
    mode: "{{ conga_bundle_files_mode | default(omit) }}"
  register: _conga_bundle_files_result
  notify: "{{ conga_bundle_files_handlers | default(omit) }}"

- name: Restart AEM when bundle file(s) changed.
  import_role:
    name: wcm_io_devops.aem_service
  vars:
    aem_service_name: "{{ conga_bundle_files_aem_service_name | mandatory }}"
    aem_service_port: "{{ conga_bundle_files_aem_service_port | mandatory }}"
    aem_service_state: restarted
  when: _conga_bundle_files_result.changed
